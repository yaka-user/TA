{% extends "base.html" %}

{% block content %}
<style>
    .table-container.scrollable-pane {
        max-height: 24rem;
        overflow-y: auto;
    }

    /* アイコン的なやつ */
    .avatar-group {
        display: flex;
        align-items: center;
        padding-left: 5px;
        /* 重なりの調整用 */
    }

    .avatar-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #46adfb;
        /* BootstrapのPrimaryカラー（お好みで変更可） */
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid var(--bs-body-bg);
        /* 重なった時の境界線 */
        margin-left: -10px;
        /* アイコンを少し重ねる */
        cursor: pointer;
        position: relative;
        transition: z-index 0.2s, transform 0.2s;
    }

    /* ホバー時に前面に出す */
    .avatar-circle:hover {
        z-index: 10;
        transform: scale(1.1);
    }

    .checkbox-list-container {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        /* Bootstrapのボーダー色 */
        border-radius: 0.375rem;
        /* Bootstrapのradius */
        padding: 0.5rem;
        background-color: var(--bs-body-bg);
    }

    .tabs {
        display: flex;
        border-bottom: 1px solid var(--bs-border-color);
        margin-bottom: 1rem;
    }

    .tab-link {
        padding: 10px 15px;
        text-decoration: none;
        color: #555;
        border-bottom: 3px solid transparent;
        font-weight: bold;
        color: var(--bs-body-color);
    }

    .tab-link:hover {
        background-color: #f8f9fa;
        color: #000;
    }

    .tab-link.active {
        border-bottom: 3px solid #0d6efd;
        color: #0d6efd;
        background-color: var(--bs-tertiary-bg);
    }
</style>

<div class="row mb-3 mt-3">
    <div class="tabs">
        <a href="/" class="tab-link active">リスト表示</a>
        <a href="/calendar" class="tab-link">カレンダー表示</a>
    </div>
</div>

<div class="row mb-3 mt-3">
    <div class="col-auto">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            ＋ タスク作成
        </button>
    </div>
    <div class="col-auto">
        <a href="/expired" class="btn btn-warning">期限切れ（未完了）を表示</a>
    </div>
</div>


<h2>私のタスク</h2>
{# ソート機能の処理 #}
<form action="/" method="GET" class="row g-2 justify-content-end align-items-center mb-2">
    <input type="hidden" name="tab" value="list">

    {# ソート機能のプルダウン選択（タスク名、締切、作成） #}
    <div class="col-auto">
        <select name="sort" class="form-select form-select-sm">
            <option value="name" {% if current_sort=='name' %}selected{% endif %}>タスク名</option>
            <option value="deadline" {% if current_sort=='deadline' %}selected{% endif %}>締め切り日時</option>
            <option value="created_at" {% if current_sort=='created_at' %}selected{% endif %}>作成日時</option>
        </select>
    </div>

    {# ソート機能のプルダウン選択（昇順、降順） #}
    <div class="col-auto">
        <select name="order" class="form-select form-select-sm">
            <option value="asc" {% if current_order=='asc' %}selected{% endif %}>昇順 (早い順)</option>
            <option value="desc" {% if current_order=='desc' %}selected{% endif %}>降順 (遅い順)</option>
        </select>
    </div>

    {# ソート機能の並び替え実行ボタン #}
    <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-outline-secondary">並び替え</button>
    </div>
</form>

{% set active_scroll = my_active_tasks|length >= 10 %}
<div class="table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>期日までの日数</th>
                <th>共有</th>
                <th>作成日時</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for task in my_active_tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td>{{ task.deadline | remaining_days | safe }}</td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
                <td>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#completeModal" data-bs-task-id="{{ task.id }}"
                        data-bs-task-name="{{ task.name }}">
                        完了
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                        data-bs-target="#updateModal" data-bs-task-id="{{ task.id }}"
                        data-bs-task-name="{{ task.name }}"
                        data-bs-task-deadline="{{ task.deadline.strftime('%Y-%m-%dT%H:%M') }}"
                        data-bs-task-shared="{{ 'true' if task.is_shared else 'false' }}"
                        data-bs-task-share-ids="{{ task.shared_with | map(attribute='id') | join(',') }}">
                        更新
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                        data-bs-target="#deleteModal" data-bs-task-id="{{ task.id }}"
                        data-bs-task-name="{{ task.name }}">
                        削除
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>完了タスク</h2>
{% set completed_scroll = my_completed_tasks|length >= 10 %}
<div class="table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>共有</th>
                <th>作成日時</th>
                <th>完了日時</th>
            </tr>
        </thead>
        <tbody>
            {% for task in my_completed_tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
                <td>{{ task.completed_at }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>共有タスク</h2>
{# ソート機能の処理 #}
<form action="/" method="GET" class="row g-2 justify-content-end align-items-center mb-2">
    <input type="hidden" name="tab" value="list">

    {# ソート機能のプルダウン選択（タスク名、締切、作成） #}
    <div class="col-auto">
        <select name="sort" class="form-select form-select-sm">
            <option value="name" {% if current_sort=='name' %}selected{% endif %}>タスク名</option>
            <option value="deadline" {% if current_sort=='deadline' %}selected{% endif %}>締め切り日時</option>
            <option value="created_at" {% if current_sort=='created_at' %}selected{% endif %}>作成日時</option>
        </select>
    </div>

    {# ソート機能のプルダウン選択（昇順、降順） #}
    <div class="col-auto">
        <select name="order" class="form-select form-select-sm">
            <option value="asc" {% if current_order=='asc' %}selected{% endif %}>昇順 (早い順)</option>
            <option value="desc" {% if current_order=='desc' %}selected{% endif %}>降順 (遅い順)</option>
        </select>
    </div>

    {# ソート機能の並び替え実行ボタン #}
    <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-outline-secondary">並び替え</button>
    </div>
</form>

{% set shared_active_scroll = shared_active_tasks|length >= 10 %}
<div class="table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>タスク作成者id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>期日までの日数</th>
                <th>共有</th>
                <th>作成日時</th>
            </tr>
        </thead>
        <tbody>
            {% for task in shared_active_tasks %}
            <tr>
                <td>{{ task.user_id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td>{{ task.deadline | remaining_days | safe }}</td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>完了共有タスク</h2>
{% set shared_completed_scroll = shared_completed_tasks|length >= 10 %}
<div class="table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>共有</th>
                <th>作成日時</th>
                <th>完了日時</th>
            </tr>
        </thead>
        <tbody>
            {% for task in shared_completed_tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
                <td>{{ task.completed_at }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% include "modals.html" ignore missing %}

<script>
    // Bootstrap Tooltipの初期化
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>

{% endblock content %}