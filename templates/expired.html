{% extends "base.html" %}

{% block content %}
<style>
    .table-container.scrollable-pane {
        max-height: 24rem;
        overflow-y: auto;
    }

    /* アイコン的なやつ */
    .avatar-group {
        display: flex;
        align-items: center;
        padding-left: 5px;
        /* 重なりの調整用 */
    }

    .avatar-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #46adfb;
        /* BootstrapのPrimaryカラー（お好みで変更可） */
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid #fff;
        /* 重なった時の境界線 */
        margin-left: -10px;
        /* アイコンを少し重ねる */
        cursor: pointer;
        position: relative;
        transition: z-index 0.2s, transform 0.2s;
    }

    /* ホバー時に前面に出す */
    .avatar-circle:hover {
        z-index: 10;
        transform: scale(1.1);
    }

    /* チェックボックスリスト用のスタイルを追加 */
    .checkbox-list-container {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        /* Bootstrapのボーダー色 */
        border-radius: 0.375rem;
        /* Bootstrapのradius */
        padding: 0.5rem;
        background-color: #fff;
    }
</style>

<div class="mb-3">
    <a href="/" class="btn btn-secondary">ホームに戻る</a>
</div>

<h2>期限切れ（未完了）のタスク</h2>
{% set expired_scroll = expired_tasks|length >= 10 %}
<div class="table-responsive table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>ステータス</th>
                <th>共有</th>
                <th>作成日時</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for task in expired_tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td><span class="badge text-bg-danger">期限切れ</span></td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
                <td>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                        data-bs-target="#updateModal" data-bs-task-id="{{ task.id }}"
                        data-bs-task-name="{{ task.name }}"
                        data-bs-task-deadline="{{ task.deadline.strftime('%Y-%m-%dT%H:%M') }}"
                        data-bs-task-share-ids="{{ task.shared_with | map(attribute='id') | join(',') }}">
                        更新
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                        data-bs-target="#deleteModal" data-bs-task-id="{{ task.id }}"
                        data-bs-task-name="{{ task.name }}">
                        削除
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>期限切れ（未完了）の共有タスク</h2>
{% set shared_expired_scroll = shared_expired_tasks|length >= 10 %}
<div class="table-responsive table-container scrollable-pane">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>id</th>
                <th>タスク名</th>
                <th>締め切り日時</th>
                <th>ステータス</th>
                <th>共有</th>
                <th>作成日時</th>
            </tr>
        </thead>
        <tbody>
            {% for task in shared_expired_tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.deadline }}</td>
                <td><span class="badge text-bg-danger">期限切れ</span></td>
                <td>
                    <div class="avatar-group">
                        {% for user in task.shared_with %}
                        {#
                        lastnameの1文字目を表示します。名前がない場合はIDの先頭を使います。
                        title属性にフルネームを入れることでツールチップに表示されます。
                        #}
                        <div class="avatar-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="{{ user.lastname }} {{ user.firstname }}">
                            {{ user.lastname[0] if user.lastname else user.id|string|first }}
                        </div>
                        {% endfor %}
                    </div>
                </td>
                <td>{{ task.created_at }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">表示する情報がありません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">タスクの更新</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="updateForm" action="" method="post">
                <input type="hidden" name="next" value="{{ request.path }}">

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">
                                <input class="form-control" type="text" name="name" id="modalTaskNameUpdate" value="">
                                <label for="modalTaskNameUpdate" class="col-form-label">タスク名</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <input class="form-control" type="datetime-local" name="deadline" id="modalTaskDeadline"
                                    value="">
                                <label for="modalTaskDeadline" class="col-form-label">締め切り日時</label>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">共有先（複数選択可）</label>
                            <div class="checkbox-list-container">
                                {% for u in followees %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="share_with" value="{{ u.id }}"
                                        id="update_share_{{ u.id }}">
                                    <label class="form-check-label" for="update_share_{{ u.id }}">
                                        {{ u.lastname }} {{ u.firstname }} ({{ u.id }})
                                    </label>
                                </div>
                                {% else %}
                                <div class="text-muted small">フォローしているユーザーがいません</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">タスクの削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>本当に「<strong id="modalTaskName"></strong>」を削除しますか？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <form id="deleteForm" action="" method="POST" style="display: inline;">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="btn btn-danger">削除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    var deleteModal = document.getElementById('deleteModal');

    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;

        var taskId = button.getAttribute('data-bs-task-id');
        var taskName = button.getAttribute('data-bs-task-name');

        var modalTaskName = document.getElementById('modalTaskName');

        var deleteForm = document.getElementById('deleteForm');

        modalTaskName.textContent = taskName;

        deleteForm.action = '/delete/' + taskId;
    });

    var updateModal = document.getElementById('updateModal');
    updateModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;

        var taskId = button.getAttribute('data-bs-task-id');
        var taskName = button.getAttribute('data-bs-task-name');
        var taskDeadline = button.getAttribute('data-bs-task-deadline');

        var taskShareIds = (button.getAttribute('data-bs-task-share-ids') || '')
            .split(',')
            .map(function (s) { return s.trim(); })
            .filter(Boolean);

        var updateForm = document.getElementById('updateForm');
        var modalTaskNameInput = document.getElementById('modalTaskNameUpdate');
        var modalTaskDeadlineInput = document.getElementById('modalTaskDeadline');

        updateForm.action = '/update/' + taskId;

        modalTaskNameInput.value = taskName;
        modalTaskDeadlineInput.value = taskDeadline;

        // チェックボックスの状態を反映するロジックに変更
        var setSelected = new Set(taskShareIds);
        // 名前が share_with のすべてのチェックボックスを取得
        var checkBoxes = updateForm.querySelectorAll('input[name="share_with"]');

        checkBoxes.forEach(function (box) {
            // box.value (ユーザID) が Set に含まれていればチェックを入れる
            box.checked = setSelected.has(String(box.value));
        });
    });
</script>

{% endblock content %}